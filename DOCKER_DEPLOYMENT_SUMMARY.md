# ğŸ³ Docker éƒ¨ç½²é…ç½®å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„é…ç½®

æœ¬æ¬¡ä¸º SCM é¡¹ç›®å®Œå–„äº†å®Œæ•´çš„ Docker éƒ¨ç½²æ–¹æ¡ˆï¼Œæ‰€æœ‰é…ç½®æ–‡ä»¶å’Œæ–‡æ¡£å·²ç»å‡†å¤‡å°±ç»ªã€‚

## ğŸ“ æ–°å¢å’Œå®Œå–„çš„æ–‡ä»¶

### 1. æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### å·²å­˜åœ¨ä¸”å®Œå–„ âœ…
- `docker/server/Dockerfile` - Server åç«¯é•œåƒé…ç½®ï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰
- `docker/admin/Dockerfile` - Admin å‰ç«¯é•œåƒé…ç½®ï¼ˆNginxï¼‰
- `docker/admin/nginx.conf` - Nginx é…ç½®ï¼ˆGzipã€ç¼“å­˜ã€APIä»£ç†ï¼‰
- `docker/docker-compose.yml` - ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®
- `docker/docker-compose.dev.yml` - å¼€å‘ç¯å¢ƒåŸºç¡€æœåŠ¡é…ç½®
- `.dockerignore` - Docker æ„å»ºå¿½ç•¥æ–‡ä»¶

### 2. æ–°å¢é…ç½®æ–‡ä»¶ ğŸ†•

```
docker/
â”œâ”€â”€ env-template.txt                      # ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
â”œâ”€â”€ docker-compose.override.yml.example   # æœ¬åœ°è¦†ç›–é…ç½®ç¤ºä¾‹
â”œâ”€â”€ nginx-reverse-proxy.conf.example      # Nginx åå‘ä»£ç†é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
â”œâ”€â”€ caddy.conf.example                    # Caddy åå‘ä»£ç†é…ç½®ï¼ˆæ¨èï¼‰
â””â”€â”€ README.md                             # Docker ç›®å½•è¯´æ˜æ–‡æ¡£
```

### 3. è¾…åŠ©è„šæœ¬ ğŸ› ï¸

```
scripts/
â”œâ”€â”€ docker-prod.sh      # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬ âœ…
â”œâ”€â”€ docker-dev.sh       # å¼€å‘ç¯å¢ƒå¯åŠ¨è„šæœ¬ âœ…
â”œâ”€â”€ docker-stop.sh      # æœåŠ¡åœæ­¢è„šæœ¬ âœ…
â”œâ”€â”€ docker-logs.sh      # æ—¥å¿—æŸ¥çœ‹è„šæœ¬ âœ…
â”œâ”€â”€ health-check.sh     # å¥åº·æ£€æŸ¥è„šæœ¬ ğŸ†•
â”œâ”€â”€ backup.sh           # æ•°æ®å¤‡ä»½è„šæœ¬ ğŸ†•
â””â”€â”€ restore.sh          # æ•°æ®æ¢å¤è„šæœ¬ ğŸ†•
```

æ‰€æœ‰è„šæœ¬å·²æ·»åŠ æ‰§è¡Œæƒé™ âœ…

### 4. æ–‡æ¡£ ğŸ“š

```
â”œâ”€â”€ QUICK_START.md              # å¿«é€Ÿå¼€å§‹æŒ‡å— ğŸ†•
â”œâ”€â”€ DEPLOYMENT.md               # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å— ğŸ†•
â”œâ”€â”€ DOCKER.md                   # å®Œæ•´ Docker éƒ¨ç½²æ–‡æ¡£ âœ…
â””â”€â”€ .github/workflows/
    â””â”€â”€ docker-build.yml.example  # CI/CD é…ç½®ç¤ºä¾‹ ğŸ†•
```

### 5. ç®¡ç†å·¥å…· âš™ï¸

```
Makefile  # Make å‘½ä»¤é›†åˆ âœ…
```

åŒ…å«çš„å‘½ä»¤ï¼š
- `make prod-up` - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
- `make dev-up` - å¯åŠ¨å¼€å‘ç¯å¢ƒ
- `make logs` - æŸ¥çœ‹æ—¥å¿—
- `make ps` - æŸ¥çœ‹æœåŠ¡çŠ¶æ€
- `make restart` - é‡å¯æœåŠ¡
- `make clean` - æ¸…ç†å®¹å™¨å’Œæ•°æ®
- `make shell-*` - è¿›å…¥å®¹å™¨
- `make db-*` - æ•°æ®åº“æ“ä½œ

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šMakefileï¼ˆæœ€ç®€å•ï¼‰

```bash
# ç”Ÿäº§ç¯å¢ƒ
make prod-up

# å¼€å‘ç¯å¢ƒ
make dev-up
```

### æ–¹å¼äºŒï¼šShell è„šæœ¬

```bash
# ç”Ÿäº§ç¯å¢ƒ
./scripts/docker-prod.sh

# å¥åº·æ£€æŸ¥
./scripts/health-check.sh

# å¤‡ä»½æ•°æ®
./scripts/backup.sh
```

### æ–¹å¼ä¸‰ï¼šDocker Compose åŸç”Ÿå‘½ä»¤

```bash
# ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker/docker-compose.yml up -d

# å¼€å‘ç¯å¢ƒ
docker-compose -f docker/docker-compose.dev.yml up -d
```

## ğŸ“Š æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Internet / Users                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Nginx / Caddy    â”‚  HTTPS (443)
         â”‚  Reverse Proxy     â”‚  HTTP (80)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ Admin  â”‚   â”‚  Server   â”‚   â”‚  MQTT  â”‚
â”‚  :8080 â”‚   â”‚   :3000   â”‚   â”‚ :1883  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
             â”‚ PostgreSQL â”‚
             â”‚   :5432    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| ğŸ–¥ï¸ Admin å‰ç«¯ | http://localhost:8080 | Vue3 ç®¡ç†ç•Œé¢ |
| ğŸ”Œ Server API | http://localhost:3000 | REST API æœåŠ¡ |
| ğŸ“¡ MQTT TCP | mqtt://localhost:1883 | MQTT åè®® |
| ğŸŒ MQTT WebSocket | ws://localhost:8083 | WebSocket åè®® |
| ğŸ“Š EMQX Dashboard | http://localhost:18083 | admin/public |
| ğŸ—„ï¸ PostgreSQL | localhost:5432 | scm/scmuser/scmpassword |

## ğŸ” ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] **å®‰å…¨é…ç½®**
  - [ ] ä¿®æ”¹ PostgreSQL é»˜è®¤å¯†ç 
  - [ ] é…ç½® MQTT è®¤è¯ï¼ˆå¦‚éœ€è¦ï¼‰
  - [ ] è®¾ç½®é˜²ç«å¢™è§„åˆ™
  - [ ] é…ç½® SSH å¯†é’¥è®¤è¯
  - [ ] å®‰è£… Fail2Ban

- [ ] **HTTPS é…ç½®**
  - [ ] é€‰æ‹©åå‘ä»£ç†ï¼ˆNginx æˆ– Caddyï¼‰
  - [ ] é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
  - [ ] è®¾ç½®è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
  - [ ] é…ç½®å®‰å…¨å¤´éƒ¨

- [ ] **æœåŠ¡é…ç½®**
  - [ ] ä¿®æ”¹ `docker/docker-compose.yml` ä¸­çš„å¯†ç 
  - [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå‚è€ƒ `docker/env-template.txt`ï¼‰
  - [ ] é™åˆ¶å¯¹å¤–æš´éœ²çš„ç«¯å£
  - [ ] é…ç½®èµ„æºé™åˆ¶

- [ ] **ç›‘æ§å’Œç»´æŠ¤**
  - [ ] é…ç½®è‡ªåŠ¨å¤‡ä»½ï¼ˆcrontabï¼‰
  - [ ] é…ç½®æ—¥å¿—è½®è½¬
  - [ ] è®¾ç½®å¥åº·æ£€æŸ¥
  - [ ] é…ç½®è¿œç¨‹å¤‡ä»½

- [ ] **æµ‹è¯•éªŒè¯**
  - [ ] è¿è¡Œ `./scripts/health-check.sh`
  - [ ] æµ‹è¯•æ•°æ®åº“è¿æ¥
  - [ ] æµ‹è¯• MQTT è¿æ¥
  - [ ] æµ‹è¯•å¤‡ä»½å’Œæ¢å¤
  - [ ] å‹åŠ›æµ‹è¯•

## ğŸ“– æ–‡æ¡£è¯´æ˜

### å¿«é€Ÿä¸Šæ‰‹
- **[QUICK_START.md](./QUICK_START.md)** - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²æŒ‡å—

### è¯¦ç»†æ–‡æ¡£
- **[DEPLOYMENT.md](./DEPLOYMENT.md)** - ç”Ÿäº§ç¯å¢ƒå®Œæ•´éƒ¨ç½²æŒ‡å—
- **[DOCKER.md](./DOCKER.md)** - Docker è¯¦ç»†æ“ä½œæ–‡æ¡£
- **[docker/README.md](./docker/README.md)** - Docker ç›®å½•è¯´æ˜

### é…ç½®å‚è€ƒ
- **docker/env-template.txt** - ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
- **docker/docker-compose.override.yml.example** - æœ¬åœ°é…ç½®è¦†ç›–
- **docker/nginx-reverse-proxy.conf.example** - Nginx é…ç½®
- **docker/caddy.conf.example** - Caddy é…ç½®

### CI/CD
- **.github/workflows/docker-build.yml.example** - GitHub Actions é…ç½®

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œ

### å¯åŠ¨æœåŠ¡
```bash
make prod-up                # ç”Ÿäº§ç¯å¢ƒ
make dev-up                 # å¼€å‘ç¯å¢ƒ
```

### æŸ¥çœ‹çŠ¶æ€
```bash
make ps                     # æœåŠ¡çŠ¶æ€
make logs                   # æ‰€æœ‰æ—¥å¿—
make logs-server            # Server æ—¥å¿—
./scripts/health-check.sh   # å¥åº·æ£€æŸ¥
```

### ç»´æŠ¤æ“ä½œ
```bash
make restart                # é‡å¯æœåŠ¡
./scripts/backup.sh         # å¤‡ä»½æ•°æ®
./scripts/restore.sh        # æ¢å¤æ•°æ®
make clean                  # æ¸…ç†å®¹å™¨
```

### è¿›å…¥å®¹å™¨
```bash
make shell-server           # Server å®¹å™¨
make shell-db               # æ•°æ®åº“
make db-studio              # Prisma Studio
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### Docker é•œåƒ
- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒå¤§å°
- âœ… ä½¿ç”¨ Alpine Linux åŸºç¡€é•œåƒ
- âœ… æ„å»ºç¼“å­˜ä¼˜åŒ–

### Nginx/Caddy
- âœ… Gzip å‹ç¼©
- âœ… é™æ€èµ„æºç¼“å­˜
- âœ… HTTP/2 æ”¯æŒ
- âšª CDN åŠ é€Ÿï¼ˆå¯é€‰ï¼‰
- âšª ç¼“å­˜å±‚ï¼ˆRedisï¼Œå¯é€‰ï¼‰

### æ•°æ®åº“
- âœ… ä½¿ç”¨ Docker Volume æŒä¹…åŒ–
- âšª è¿æ¥æ± é…ç½®
- âšª æŸ¥è¯¢ä¼˜åŒ–
- âšª å®šæœŸç»´æŠ¤

## ğŸ”§ æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨
```bash
make logs                   # æŸ¥çœ‹æ—¥å¿—
make ps                     # æ£€æŸ¥çŠ¶æ€
docker system df            # æ£€æŸ¥ç£ç›˜ç©ºé—´
```

### ç«¯å£å†²çª
```bash
lsof -i :8080              # æ£€æŸ¥ç«¯å£å ç”¨
# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
```

### æ•°æ®åº“é—®é¢˜
```bash
make logs-db               # æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
make shell-db              # è¿›å…¥æ•°æ®åº“
```

### æ¸…ç†å’Œé‡ç½®
```bash
make clean                 # æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ•°æ®
docker system prune -a     # æ¸…ç† Docker ç³»ç»Ÿ
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

- **æœåŠ¡å¥åº·**ï¼šHTTP å¥åº·æ£€æŸ¥ç«¯ç‚¹
- **èµ„æºä½¿ç”¨**ï¼šCPUã€å†…å­˜ã€ç£ç›˜
- **æ•°æ®åº“**ï¼šè¿æ¥æ•°ã€æŸ¥è¯¢æ€§èƒ½
- **MQTT**ï¼šè¿æ¥æ•°ã€æ¶ˆæ¯ååé‡
- **æ—¥å¿—**ï¼šé”™è¯¯ç‡ã€å“åº”æ—¶é—´

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç«‹å³å¯ç”¨**
   ```bash
   make prod-up
   ./scripts/health-check.sh
   ```

2. **ç”Ÿäº§éƒ¨ç½²**ï¼ˆå‚è€ƒ DEPLOYMENT.mdï¼‰
   - é…ç½® HTTPS
   - ä¿®æ”¹é»˜è®¤å¯†ç 
   - è®¾ç½®é˜²ç«å¢™
   - é…ç½®å¤‡ä»½

3. **æŒç»­æ”¹è¿›**
   - æ·»åŠ ç›‘æ§å‘Šè­¦
   - é…ç½®æ—¥å¿—èšåˆ
   - æ€§èƒ½è°ƒä¼˜
   - æ‰©å®¹è§„åˆ’

## ğŸ’¡ æŠ€æœ¯æ ˆ

- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **å‰ç«¯**: Vue 3 + Naive UI + Vite
- **åç«¯**: Node.js + Koa + TypeScript
- **æ•°æ®åº“**: PostgreSQL + Prisma
- **æ¶ˆæ¯é˜Ÿåˆ—**: EMQX MQTT Broker
- **åå‘ä»£ç†**: Nginx / Caddy
- **éƒ¨ç½²**: Makefile + Shell Scripts

## ğŸ“ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹æ–‡æ¡£ï¼š`docs/` ç›®å½•
2. è¿è¡Œå¥åº·æ£€æŸ¥ï¼š`./scripts/health-check.sh`
3. æŸ¥çœ‹æ—¥å¿—ï¼š`make logs`
4. æäº¤ Issueï¼šé¡¹ç›® GitHub é¡µé¢

---

## âœ… éƒ¨ç½²é…ç½®å®Œæˆï¼

æ‰€æœ‰ Docker éƒ¨ç½²é…ç½®å·²ç»å®Œå–„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

**å¿«é€Ÿå¼€å§‹**ï¼š
```bash
make prod-up
```

**è¯¦ç»†æŒ‡å¯¼**ï¼šå‚è€ƒ [QUICK_START.md](./QUICK_START.md) å’Œ [DEPLOYMENT.md](./DEPLOYMENT.md)

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸ‰

